version: '3.8'

services:
  checkapp-backend:
    image: checkapp-backend:latest
    networks:
      - network_public

    environment:
      - NODE_ENV=production
      - BACKEND_PORT=3223
      - FRONTEND_URL=https://zero19.top
      - DATABASE_URL=postgresql://postgres:vVQbSycgpXmP57@72.61.218.13:5432/shoppings
      - GOOGLE_SHEETS_CLIENT_EMAIL=painel-checkapp@mauan8n.iam.gserviceaccount.com
      - GOOGLE_SHEETS_PRIVATE_KEY=|
          -----BEGIN PRIVATE KEY-----
          MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCYjEEo48ImH3/l
          JPf87sjaPsbZuOWhvYm31pwJHZo8zpZh4IUeAYZrMD7glqT9rupTbHvgogolXHC7
          JE+ANEFjik49PbZAHYlxJBOYrrOQSHAsXIhSA8LlVlY2pT4/E7oHqZlniv2UejY/
          a7ow7aexj5nBdNJY6PiRqRqT5if0nvV/JCpcVp2hxzNwYqdTTqxWtGvKUmJ8+YBA
          9oQlqeJYk3B/xLCcbAIQNQP12WtOns1twxl5iMpSEl3s+uNkafvI3GOS3ASwAq0a
          sa8pD7J4W5YpX35AJkdhRpYOuE47kCA5KPAxoCewNY3R7klHrMtTrfQFHuexGk2E
          0WrzUxwnAgMBAAECggEANTrnt9F122Cte7OBN0jJXGKAd9OtiVk+l6Ay9XlXazV5
          QzEZskU89uUwY6UdcIobKT4XIeTZHn1ZtuuuNCHH2WiW8Ya5tDi6T3kTv3jinouw
          XMJzLQ8z8FvGnK3fgRoslWToazmUT72vdUTthQpAtFRUBi3yAmVU61rzM72hnplZ
          IOaxFkm7MPCeUW2bKlA239hcxacBtnfxbmmeG185YjT+drU7HoOH47s6Z3Sb9zvO
          W8XsOcFAFQxOftBpojvEljEuPL15bZWoAk/u2YMBOJb4Tms3EmsGisL6VOa0Qk1W
          OwlkKd8XZhfm4RXA9SflBNPUeKdYW41Wy0GfLcyRoQKBgQDP02xbnBep5aaKwANU
          Ua/sAjK6jNevRD9POO1xwDfvynd9A2KvYp+SOA45S0O4LWUcHZHe3gwLGRcb3/DB
          Y/HEJg/ojIQfaxMrhD6SVrlEAiKQBpo6NhtW2jQWqIIVdYStijJe8t9Q+Ef8C/aL
          bc+MddIcwF6AyaOaZHWgEtti4QKBgQC76JWME73dGQm2iqMCp09yomrQsNW5O7hX
          CFNxH6wMoiG+CSgDkXoysogDixERo/16CjIoeGvFvXDfM+QSgz/tmKuevdQ5h3aS
          Vyx6vltwOr6bvVIb08sb/J/0gt/wWHSolgmRU35kIVCOegjNK/AbMtwcn7bKmlwa
          e8uxXChoBwKBgQDEJ/jRar4HFQQhV+SMlGFocBazbzYwbkkXHFM5F0V0pfQr4aMm
          iP62AwSh3UE4uFgDtoE1Cv3xB6iBHdheoFfUXFyNkPsvsF+ypips80AASceXizPM
          l78sNd4OONQ3Lumg5pxuc+yFvyIqapw0s9u+5oH/sy4/fpJVqlY/VS0O4QKBgA9P
          mD/dq+7EB4KUMUwaDeMtUL7IaeG59/8/cm0ZQ4+T9mPhox0HUYmn+mUvg6iIUDMN
          eaDKjx2BnhzRwZewkhjuA63fkddOLl8mMz2dHR476yQNfQ8/ZqFVKENoFo8i5f6G
          myj4QKgv/rxdPTJajinpLv42FVLU2QRfae19sN0pAoGBAIOaiNTm8RlyIAbA2j4D
          v0RhMpl5k6oq0WcEKYW5Na/QLaA/7Cb0Gnyu4VQv2DSiBwL9oFTyflU4lJQrjvzO
          hFc1pUBzufayEWuTWAqnmaonwX4zD+eeFF+KbrZaXmGqG5S9J2OVxqjEQ1nQeu8/
          vSvALm8uFh9vE4shu7hpZZpY
          -----END PRIVATE KEY-----
      - GOOGLE_DRIVE_FOLDER_ID=1nYCPKmfR8rJlAuWyaafCb3o73m_kpz5k

    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=network_public"
      - "traefik.http.routers.checkapp-backend.rule=Host(`apicheckapp.zero19.top`)"
      - "traefik.http.routers.checkapp-backend.entrypoints=websecure"
      - "traefik.http.routers.checkapp-backend.priority=1"
      - "traefik.http.routers.checkapp-backend.tls.certresolver=letsencryptresolver"
      - "traefik.http.routers.checkapp-backend.service=checkapp-backend"
      - "traefik.http.services.checkapp-backend.loadbalancer.server.port=3223"
      - "traefik.http.routers.checkapp-backend.middlewares=checkapp-backend-headers"
      - "traefik.http.middlewares.checkapp-backend-headers.headers.customrequestheaders.X-Forwarded-Proto=https"

    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3223/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

networks:
  network_public:
    external: true
